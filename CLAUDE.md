# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Development Commands

### Core Development
```bash
# Start development server (auto-updates Git dates)
npm run dev

# Build for production (includes Git date updates)
npm run build

# Start production server
npm start

# Type checking
npm run typecheck

# Linting
npm run lint

# Update Git-based page dates for SEO
npm run update-dates
```

### Environment Setup
Create `.env.local` with:
```
# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=your-supabase-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-supabase-anon-key

# Vercel Blob Configuration
BLOB_READ_WRITE_TOKEN=your-vercel-blob-token

# Base URL Configuration
NEXT_PUBLIC_BASE_URL=http://localhost:3000

# Cron Job Security
CRON_SECRET=your-cron-secret

# External API Configuration
VVRL_API_KEY=your-vvrl-api-key

# Admin Authentication
NEXT_PUBLIC_ADMIN_EMAILS=admin1@example.com,admin2@example.com
```

## Architecture Overview

### Multi-language Next.js App Router Structure
- Uses `[locale]` dynamic routing for internationalization (zh, en, jp, es)
- Middleware handles locale detection and URL rewriting
- Default locale is 'zh' (Chinese), accessed via root path `/`
- Other locales use prefixed paths like `/en/`, `/jp/`

### Key Technologies
- **Framework**: Next.js 15 with App Router
- **Database**: Supabase (PostgreSQL) with Row Level Security
- **File Storage**: Vercel Blob for image uploads
- **Styling**: Tailwind CSS
- **Internationalization**: Custom middleware + next-intl
- **Authentication**: Supabase Auth (admin areas only)

### Git-based SEO System
- Automatic page date tracking using Git history
- `scripts/update-git-dates.mjs` extracts creation/modification dates
- `src/lib/utils.ts` contains `FILE_DATES` object and `getPageDates()` function
- Runs automatically during `npm run dev` and `npm run build`

### Core Features Architecture

#### Image Search Tool
- **Upload**: Files processed via `/api/upload` â†’ Vercel Blob storage
- **Search**: Multiple engines (Google, Bing, Yandex, TinEye, SauceNAO)
- **Storage**: Search records saved to Supabase `image_searches` table
- **Components**: `ImageForm.tsx`, `SearchButtons.tsx`

#### Multi-tool Platform
- **Date Calculator**: Date difference and addition calculations
- **Due Date Calculator**: Pregnancy timeline calculator
- **Gift Exchange**: Random participant assignment with unique IDs
- **Short URL**: URL shortening service with click tracking
- **Image URL**: Image file upload with short URL generation (Cloudflare R2)
- **Video URL**: Video file upload with streaming and short URL generation (Bunny.net)
- **File URL**: General file upload with short URL generation (Cloudflare R2)
- **Color Picker**: Color selection and conversion tool
- **Contact Form**: User inquiry form with device info tracking

### Database Schema (Supabase)
```sql
-- Main table for tracking image searches
CREATE TABLE image_searches (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  image_url TEXT NOT NULL,
  search_engine TEXT[] NOT NULL,
  device_type TEXT NOT NULL,
  country_code TEXT,
  browser TEXT,
  os TEXT,
  searched_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  ip_address TEXT
);

-- Table for storing contact form messages with device tracking
CREATE TABLE contact_messages (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  email TEXT NOT NULL,
  message TEXT NOT NULL,
  device_type TEXT,
  browser TEXT,
  os TEXT,
  country_code TEXT,
  ip_address TEXT,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- Table for gift exchange wheel functionality
CREATE TABLE gift_exchange_wheel (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  code TEXT NOT NULL UNIQUE,
  participant_count INTEGER NOT NULL,
  participant_names TEXT[] NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  results TEXT[] DEFAULT '{}'::TEXT[]
);
```

### File Structure Patterns
- **Pages**: `src/app/[locale]/[feature]/page.tsx`
- **Components**: `src/app/[locale]/[feature]/components/`
- **API Routes**: `src/app/api/[endpoint]/route.ts`
- **Lib Functions**: `src/lib/[feature]/` (Supabase operations)
- **Shared Components**: `src/components/`

### Middleware Logic
- Handles locale routing and URL rewriting
- Admin authentication for protected routes
- Static file and API route bypassing
- Special handling for auth callbacks

### Device Information Tracking
- **Automatic Collection**: All upload forms and contact form collect device info via `/api/device-info`
- **Data Points**: Device type (desktop/mobile/tablet), browser, OS, country code, IP address
- **Privacy**: IP addresses are anonymized for privacy compliance
- **Fallback**: Forms work even if device info collection fails

### Important Notes
- All user-facing content is multilingual (zh/en/jp/es)
- SEO dates are automatically maintained via Git integration
- Image uploads are limited to 5MB, video uploads to 100MB, general files to 15MB
- Admin areas require Supabase authentication
- All API routes include proper error handling and validation
- Device information is automatically tracked for analytics and debugging